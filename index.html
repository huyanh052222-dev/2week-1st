<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Cloud</title>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
    /* T√¥ng m√†u t·ª´ Code 2 */
    --purple-bg: #8c7ae6; 
    --dark-purple-sidebar: #523f9b; 
    --cover-purple: #523f9b; 
    --paper-color: #f7f3e8; 
    --red-block: #b36363; 
    --blue-block: #749fa3; 
    --text-color: #2c2c2c;
    --handwriting-font: 'Pacifico', cursive; 
    --main-font: 'Inter', sans-serif; 
    --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.2); 
}

body {
    margin: 0;
    font-family: var(--main-font);
    background: var(--purple-bg);
    display: flex;
    height: 100vh;
    overflow: hidden;
    color: var(--text-color);
}

/* --- SIDEBAR (Code 2) --- */
.container-sidebar {
    width: 250px; 
    background: var(--dark-purple-sidebar);
    color: white;
    display: flex;
    flex-direction: column;
    padding: 20px 0;
    box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
    z-index: 100;
}
.side-bar {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 0 20px;
}
.sidebar-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 24px;
    font-weight: 700;
    padding-bottom: 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-wrap: wrap;
}
.eirlys-logo {
    font-family: var(--handwriting-font);
    font-size: 32px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    color: var(--dark-purple-sidebar);
    font-weight: 400;
}
.link-integrations {
    width: 100%;
    font-size: 14px;
    font-weight: 400;
    opacity: 0.7;
    margin-top: 5px;
    margin-left: 50px;
}
.main-menu {
    flex-grow: 1; 
}
.bottom-menu {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 20px;
}
.side-bar a {
    color: white;
    text-decoration: none;
    padding: 12px 15px;
    margin: 4px 0;
    display: flex; 
    align-items: center;
    gap: 10px;
    border-radius: 8px;
    transition: background 0.2s, transform 0.2s;
    font-weight: 500;
}
.side-bar a i {
    width: 20px;
    text-align: center;
}
.side-bar a.active-nav {
    background: rgba(255, 255, 255, 0.15);
    font-weight: 600;
}
.side-bar a:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* --- BOOK CONTAINER (Code 2) --- */
.container-wrap-content {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

.book {
    width: 900px; 
    height: 90vh; 
    max-height: 850px; 
    perspective: 2500px;
    position: relative;
    display: flex;
    justify-content: center; 
    align-items: center;
    gap: 0px; 
}

.paper {
    width: 450px; 
    height: 100%;
    position: absolute;
    transform-origin: left;
    transform-style: preserve-3d;
    transition: transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94), z-index 0.5s;
    border-radius: 12px; 
}

.flipped {
    transform: rotateY(-180deg);
}

.front,
.back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    padding: 30px;
    box-sizing: border-box;
    overflow: auto; /* Cho ph√©p cu·ªôn n·ªôi dung */
    border-radius: 12px;
    background: var(--paper-color); 
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
}

.back {
    transform: rotateY(180deg);
    background: var(--paper-color);
}

/* Style cho b√¨a (Code 2) */
.book-cover {
    background: var(--cover-purple); 
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 28px;
    text-align: center;
    user-select: none;
    gap: 30px;
}
.cover-title-main {
    font-family: var(--handwriting-font);
    font-size: 60px; 
    margin-bottom: -10px;
}
.cover-title-sub {
    font-size: 20px;
    font-weight: 400;
}
.cover-image-placeholder {
    width: 180px;
    height: 120px;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--handwriting-font);
    font-size: 32px;
    color: var(--text-color);
}
.cover-start-btn {
    padding: 12px 30px;
    background: white;
    color: var(--cover-purple);
    border: none;
    border-radius: 25px;
    font-weight: 600;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.cover-start-btn:hover {
    transform: translateY(-2px);
}

/* C√°c layout block (t·ª´ code 2, d√†nh cho trang m·∫´u trong ·∫£nh) */
.layout-container {
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.layout-front-1 .block-top {height: 15%; background: var(--red-block); border-radius: 8px;}
.layout-front-1 .block-main {height: 80%; background: var(--red-block); border-radius: 8px;}
.layout-back-1 {display: grid; grid-template-rows: 40% 55%; gap: 15px;}
.layout-back-1 .block-top-group {display: grid; grid-template-columns: 40% 55%; gap: 15px;}
.layout-back-1 .block-top-group .block-left {background: var(--red-block); border-radius: 8px;}
.layout-back-1 .block-top-group .block-right {background: var(--blue-block); border-radius: 8px;}
.layout-back-1 .block-bottom {background: var(--red-block); border-radius: 8px;}
.layout-front-2 {display: grid; grid-template-rows: 15% 30% 25% 20%; gap: 15px;}
.layout-front-2 .block-top {background: var(--red-block); border-radius: 8px;}
.layout-front-2 .block-mid-group {display: grid; grid-template-columns: 40% 55%; gap: 15px;}
.layout-front-2 .block-mid-group .block-mid-left {background: var(--blue-block); border-radius: 8px;}
.layout-front-2 .block-mid-group .block-mid-right {background: var(--red-block); border-radius: 8px;}
.layout-front-2 .block-large-mid {background: var(--red-block); border-radius: 8px;}
.layout-front-2 .block-bottom {background: var(--blue-block); border-radius: 8px;}
.layout-back-2 {display: grid; grid-template-rows: 40% 55%; gap: 15px;}
.layout-back-2 .block-top-group {display: grid; grid-template-columns: 40% 55%; gap: 15px;}
.layout-back-2 .block-top-group .block-left {background: var(--red-block); border-radius: 8px;}
.layout-back-2 .block-top-group .block-right {background: var(--blue-block); border-radius: 8px;}
.layout-back-2 .block-bottom {background: var(--red-block); border-radius: 8px;}
.footer-dots {
    position: absolute;
    bottom: 10px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
}
.dot {width: 8px; height: 8px; background: #ccc; border-radius: 50%;}
.dot.active {background: #777;}


/* --- N√∫t ƒëi·ªÅu h∆∞·ªõng (Code 2) --- */
#prev-page-btn,
#next-page-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    font-size: 24px;
    padding: 0;
    cursor: pointer;
    border: none;
    border-radius: 50%;
    background: #fff; 
    color: var(--text-color);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.nav-btn.left-btn {
    left: calc(250px + 50px); 
} 
.nav-btn.right-btn {
    right: 50px; 
}

#prev-page-btn:hover,
#next-page-btn:hover {background: #eee;}

/* --- FLOATING MENU (Code 2) --- */
#toggle-toolbar-menu { 
    position: fixed; 
    top: 20px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
    z-index: 2000;
    width: 40px;
    height: 40px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
#music-toggle { /* ƒêi·ªÅu ch·ªânh n√∫t nh·∫°c */
    color: var(--dark-purple-sidebar) !important;
    right: 80px !important;
    background: white !important;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

#floating-menu {
    position: fixed;
    top: 70px; 
    right: 20px;
    width: 250px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    z-index: 1999;
    display: none; 
    flex-direction: column;
    gap: 15px;
    font-size: 16px;
}

#floating-menu.show {
    display: flex;
}
.menu-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}
.menu-group:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.menu-group.style-buttons button {
    width: 30px;
    height: 30px;
    font-size: 18px;
    font-weight: 700;
    background: #f0f0f0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.menu-group.select-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 10px;
}

.menu-group select {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-family: var(--main-font);
}

.menu-group.color-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.menu-group input[type="color"] {
    width: 40px;
    height: 30px;
    padding: 0;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.menu-group.align-buttons button {
    flex: 1;
    background: #f0f0f0;
    border: none;
    padding: 8px 0;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}
.menu-group.align-buttons button:nth-child(4) { /* CƒÉn ƒê·ªß */
    margin-top: 10px;
    flex-basis: 100%;
}

.menu-group.align-buttons button.active-align {
    background: #007bff;
    color: white;
}

.menu-group.action-buttons {
    flex-direction: column;
    gap: 5px;
}
.menu-group.action-buttons button {
    background: #e9ecef;
    border: none;
    padding: 10px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 10px;
}
.menu-group.action-buttons .add-page-button {
    background: var(--purple-bg);
    color: white;
}

.paper [contenteditable="true"] {
    outline: none; /* B·ªè vi·ªÅn focus m·∫∑c ƒë·ªãnh */
}

/* Th√™m styling cho ·∫£nh ƒë∆∞·ª£c ch√®n (t√πy ch·ªçn) */
.paper img {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 10px 0;
}

/* --- Responsive cho ƒëi·ªán tho·∫°i (Code 2) --- */
@media (max-width: 1024px) {
    .container-sidebar {
        width: 80px;
    }
    .side-bar a span {
        display: none;
    }
    .sidebar-header .link-integrations,
    .sidebar-header > div:not(.eirlys-logo) {
        display: none;
    }
    .container-wrap-content {
        padding-left: 80px;
    }
    .book {
        width: 400px; /* S·ªï ƒë∆°n trang */
    }
    .paper {
        width: 100%;
        height: 90%;
    }
    .nav-btn.left-btn {
        left: calc(80px + 10px); 
    }
    .nav-btn.right-btn {
        right: 10px; 
    }
}
*{ margin:0; padding:0; box-sizing:border-box; }
:root{
  --mint:#C8F7E0;
  --purple:#E6D8FF;
  --blue:#D7EAFE;
  --peach:#FFE6CC;
  --text:#222;
  --muted:#6b6b6b;
  --card-w:320px;
  --card-h:320px;
  --gap:20px;
  --move-up:8px;
  --transition-time:500ms;
}
body{
  font-family:'Montserrat',sans-serif;
  background:#fff;
  color:var(--text);
}
.container{
  max-width:1120px;
  margin-inline:1.5rem;
}
.testimonial{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:36px 0 80px;
}
.testimonial-title{
  font-family:'Unbounded',sans-serif;
  font-size:30px;
  text-align:center;
  margin-bottom:28px;
  color:#111;
  line-height:1.05;
  justify-content: center;
  align-items: center;
}
.testimonial-box{
  padding-bottom:0;
  width:100%;
}
.slider-root{
  width:820px;
  margin:0 auto;
  position:relative;
  overflow:hidden;
  padding:28px 40px;
  background:linear-gradient(180deg,#FBFEFF 0%,#F6FCF9 100%);
  border-radius:16px;
  box-shadow:0 10px 30px rgba(16,20,30,0.06);
}
.slider-track{
  display:flex;
  gap:var(--gap);
  align-items:center;
  height:calc(var(--card-h) + 40px);
  transition:transform var(--transition-time) ease;
  will-change:transform;
  padding:8px 0;
}
.testimonial-card{
  width:var(--card-w);
  height:var(--card-h);
  background:var(--purple);
  border-radius:14px;
  box-shadow:0 10px 30px rgba(10,10,10,0.06);
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  transition:transform var(--transition-time) ease, filter var(--transition-time) ease, opacity var(--transition-time) ease;
  transform-origin:center bottom;
  overflow:hidden;
}
.testimonial-img{
  width:100px;
  height:100px;
  border-radius:50%;
  object-fit:cover;
  border:4px solid rgba(255,255,255,0.7);
  box-shadow:0 8px 18px rgba(0,0,0,0.08);
  margin-bottom:12px;
}
.testimonial-name{ font-size:1rem; margin-bottom:8px; font-weight:600; color:#111; }
.testimonial-rating{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.testimonial-stars i{ color:#FFB86B; font-size:1rem; }
.testimonial-number{ font-size:0.95rem; color:var(--muted); font-weight:600; }
.testimonial-descrip{ font-size:0.95rem; color:#333; line-height:1.35; margin-top:6px; }
.testimonial-card.center{
  transform:translateY(calc(-1 * var(--move-up))) scale(1.04);
  filter:none;
  opacity:1;
  box-shadow:0 28px 70px rgba(10,12,20,0.12);
  z-index:30;
}
.testimonial-card.side{
  transform:translateY(0) scale(0.96);
  filter:blur(2px) saturate(0.95);
  opacity:0.85;
  z-index:20;
  box-shadow:0 12px 30px rgba(10,12,20,0.06);
}
.testimonial-card.dim{
  transform:translateY(0) scale(0.9);
  filter:blur(2.5px) grayscale(0.05);
  opacity:0.6;
  z-index:10;
  box-shadow:none;
}
.dots-root{
  width:820px;
  margin:14px auto 0;
  display:flex;
  justify-content:center;
  gap:10px;
}
.dots-root button{
  width:10px;
  height:10px;
  border-radius:50%;
  border:none;
  background:rgba(0,0,0,0.08);
  cursor:pointer;
  transition:transform 200ms ease, background 200ms ease, box-shadow 200ms ease;
}
.dots-root button.active{
  background:linear-gradient(90deg,var(--mint),var(--purple));
  box-shadow:0 6px 18px rgba(120,120,150,0.12);
  transform:scale(1.18);
}
.dots-root button:focus{ outline:2px solid rgba(0,0,0,0.06); transform:scale(1.25); }
    </style>
</head>
<body>
    <div class="container-sidebar">
        <div class="side-bar">
            <div class="sidebar-header">
                <div class="eirlys-logo">EL</div>
                Eirlys
                <!-- <div class="link-integrations">ü¶äüî•</div> -->
            </div>
            
            <div class="main-menu">
                <a href="index.html" class="side-item active-nav" title="Trang Ch·ªß">
                    <i class="fas fa-home"></i> Trang Ch·ªß
                </a>
                <a href="rate.html" class="side-item" title="ƒê√°nh Gi√°">
                    <i class="fas fa-file-invoice"></i> ƒê√°nh gi√°
                </a>
                <a href="contact.html" class="side-item" title="Li√™n L·∫°c">
                    <i class="fas fa-address-book"></i> Li√™n L·∫°c
                </a>
                <a href="#" class="side-item" id="add-page-sidebar-btn" title="Th√™m trang">
                    <i class="fas fa-plus"></i> Th√™m trang 
                </a>
            </div>

            <div class="bottom-menu">
                <a href="#" class="side-item" title="C√¥ng c·ª•">
                    <i class="fas fa-tools"></i> C√¥ng c·ª•
                </a>
                <a href="#" class="side-item" title="Tr·ª£ gi√∫p">
                    <i class="fas fa-question-circle"></i> Tr·ª£ gi√∫p
                </a>
            </div>
        </div>
    </div>

<div class="container-wrap-content">
    <button id="prev-page-btn" class="nav-btn left-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <div class="book" id="book"></div>
    <button id="next-page-btn" class="nav-btn right-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
    </button>
</div>

<button id="toggle-toolbar-menu">
    <i class="fas fa-bars"></i>
</button>

<div id="floating-menu">
    <div class="menu-group style-buttons">
        <button data-cmd="bold">B</button>
        <button data-cmd="italic">I</button>
        <button data-cmd="underline">U</button>
    </div>
    
    <div class="menu-group select-row">
        <select id="font-family">
            <option value="Inter, sans-serif">Inter</option>
            <option value="Nunito, sans-serif">Nunito</option>
            <option value="Arial, sans-serif">Arial</option>
            <option value="Pacifico, cursive">Handwriting</option>
        </select>
        <select id="font-size">
            <option value="16px">Normal</option>
            <option value="14px">Small</option>
            <option value="18px">Medium</option>
            <option value="24px">Large</option>
        </select>
    </div>
    
    <div class="menu-group color-row">
        <label for="color">M√†u ch·ªØ:</label>
        <input type="color" id="color" value="#2c2c2c">
    </div>

    <div class="menu-group align-buttons">
        <button data-cmd="justifyLeft" class="align-btn active-align">CƒÉn Tr√°i</button>
        <button data-cmd="justifyCenter" class="align-btn">CƒÉn Gi·ªØa</button>
        <button data-cmd="justifyRight" class="align-btn">CƒÉn Ph·∫£i</button>
        <button data-cmd="justifyFull" class="align-btn">CƒÉn ƒê·ªß</button>
    </div>

    <div class="menu-group action-buttons">
        <button id="insert-image-btn" class="action-btn link-button">
            <i class="fas fa-image"></i> Th√™m ·∫£nh
        </button>
        <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
        
        <button data-cmd="createLink" class="action-btn link-button">üîó Th√™m Li√™n k·∫øt</button>
        <button id="add-page-panel-btn" class="action-btn add-page-button">‚ûï Th√™m trang m·ªõi</button>
    </div>
</div>

<button id="music-toggle" style="position: fixed; top: 20px; right: 80px; font-size: 24px; cursor: pointer; z-index: 2000; background: none; border: none; color: white;">üîä</button>

<audio id="bgMusic" loop autoplay>
    <source src="c√≥ h·∫πn v·ªõi thanh xu√¢n - MONSTAR _ official music video.mp3" type="audio/mpeg">
</audio>
<script>
    const book = document.getElementById('book');
const prevBtn = document.getElementById('prev-page-btn');
const nextBtn = document.getElementById('next-page-btn');
const addPageSidebarBtn = document.getElementById('add-page-sidebar-btn');

const floatingMenu = document.getElementById('floating-menu');
const toggleToolbarMenu = document.getElementById('toggle-toolbar-menu');
const addPagePanelBtn = document.getElementById('add-page-panel-btn');

const insertImageBtn = document.getElementById('insert-image-btn');
const imageUploadInput = document.getElementById('image-upload-input');
const musicToggle = document.getElementById('music-toggle');
const bgMusic = document.getElementById('bgMusic');

let pages = [], currentPage = 0;
let savedRange = null;

// C√°c Layout m·∫´u (Code 2)
const Layouts = {
    COVER: `
        <div class="front book-cover">
            <div class="cover-title-main">Eirlys</div>
            <div class="cover-title-sub">N∆°i l∆∞u gi·ªØ k·ªâ ni·ªám</div>
            <div class="cover-image-placeholder">·∫¢nh</div>
            <button class="cover-start-btn" id="start-btn">B·∫Øt ƒë·∫ßu</button>
        </div>
        <div class="back"></div>
    `,
    
    PAGE_1_LAYOUT: `
        <div class="front layout-container layout-front-2">
            <div class="block-top"></div>
            <div class="block-mid-group">
                <div class="block-mid-left"></div>
                <div class="block-mid-right"></div>
            </div>
            <div class="block-large-mid"></div>
            <div class="block-bottom"></div>
            <div class="footer-dots"><div class="dot active"></div><div class="dot"></div></div>
        </div>
        <div class="back layout-container layout-back-2">
            <div class="block-top-group">
                <div class="block-left"></div>
                <div class="block-right"></div>
            </div>
            <div class="block-bottom">Frame 41</div>
            <div class="footer-dots"><div class="dot"></div><div class="dot active"></div></div>
        </div>
    `,
    
    PAGE_BLANK: `
        <div class="front content"></div>
        <div class="back content"></div>
    `
};

// --- CH·ª®C NƒÇNG L∆ØU/KH√îI PH·ª§C CON TR·ªé (QUAN TR·ªåNG CHO VI·ªÜC CH√àN ·∫¢NH) ---
function saveSelection() {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        // ƒê·∫£m b·∫£o ch·ªâ l∆∞u range n·∫øu n√≥ n·∫±m trong m·ªôt v√πng contenteditable
        const container = range.commonAncestorContainer.closest('[contenteditable="true"]');
        if (container) {
            savedRange = range.cloneRange();
        }
    }
}

function restoreSelection() {
    if (savedRange) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedRange);
    }
}

// --- CH·ª®C NƒÇNG T·∫†O/TH√äM TRANG ---
function createPage(contentTemplate, isEditable = true) {
    const page = document.createElement('div');
    page.className = 'paper';
    page.innerHTML = contentTemplate;
    page.style.zIndex = 100 - pages.length;
    book.appendChild(page);
    pages.push(page);
    
    if (isEditable) {
        page.querySelectorAll('.front, .back').forEach(el => {
            el.setAttribute('contenteditable', 'true');
            el.addEventListener('mouseup', saveSelection);
            el.addEventListener('keyup', saveSelection);
        });
    }
    return page;
}

function addNewPage() {
    // Lu√¥n ƒë·∫£m b·∫£o c√≥ trang cu·ªëi c√πng kh√¥ng l·∫≠t ƒë·ªÉ che ph√≠a sau
    const lastPage = pages.pop();
    if (lastPage) {
        book.removeChild(lastPage);
    }
    
    // Th√™m trang m·ªõi c√≥ th·ªÉ ch·ªânh s·ª≠a
    createPage(Layouts.PAGE_BLANK, true);

    // Th√™m l·∫°i trang cu·ªëi c√πng kh√¥ng l·∫≠t
    createPage(Layouts.PAGE_BLANK, false); 
    
    currentPage = pages.length - 2; // L√πi v·ªÅ trang v·ª´a th√™m
    updatePages();
}

function updatePages() {
    pages.forEach((p, i) => {
        if (i < currentPage) {
            p.classList.add('flipped');
            p.style.zIndex = i; 
        } else {
            p.classList.remove('flipped');
            p.style.zIndex = pages.length - i; 
        }
    });

    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage === pages.length - 1;
}


// --- CH·ª®C NƒÇNG C√îNG C·ª§ CH·ªàNH S·ª¨A ---
floatingMenu.querySelectorAll('button[data-cmd]').forEach(btn => {
    btn.addEventListener('click', () => {
        restoreSelection();
        const cmd = btn.dataset.cmd;
        if (cmd === 'createLink') {
            const url = prompt("Nh·∫≠p URL:");
            if (url) document.execCommand(cmd, false, url);
        } else if (cmd.startsWith('justify')) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho n√∫t cƒÉn l·ªÅ
            floatingMenu.querySelectorAll('.align-buttons .align-btn').forEach(b => b.classList.remove('active-align'));
            btn.classList.add('active-align');
            document.execCommand(cmd, false, null);
        } else {
            document.execCommand(cmd, false, null);
        }
    });
});

document.getElementById('font-family').addEventListener('change', e => {
    restoreSelection();
    document.execCommand('fontName', false, e.target.value);
});

document.getElementById('font-size').addEventListener('change', e => {
    restoreSelection();
    // Chuy·ªÉn size: 14px -> 3, 16px -> 4, 18px -> 5, 24px -> 6 (Do execCommand ch·ªâ ch·∫•p nh·∫≠n size 1-7)
    let sizeValue = '4';
    switch(e.target.value) {
        case '14px': sizeValue = '3'; break; 
        case '18px': sizeValue = '5'; break; 
        case '24px': sizeValue = '6'; break; 
    }
    document.execCommand('fontSize', false, sizeValue);
});

document.getElementById('color').addEventListener('change', e => {
    restoreSelection();
    document.execCommand('foreColor', false, e.target.value);
});

// --- LOGIC T·∫¢I ·∫¢NH L√äN ---
insertImageBtn.addEventListener('click', () => {
    imageUploadInput.click();
});

imageUploadInput.addEventListener('change', function(event) {
    if (event.target.files && event.target.files[0]) {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            restoreSelection(); 
            if (savedRange && savedRange.commonAncestorContainer.closest('[contenteditable="true"]')) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Uploaded Image';
                
                // Ch√®n ·∫£nh v√†o v·ªã tr√≠ con tr·ªè
                savedRange.deleteContents();
                savedRange.insertNode(img);
                
                // ƒê·∫∑t l·∫°i con tr·ªè sau ·∫£nh
                savedRange.setEndAfter(img);
                savedRange.collapse(false);
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);

                // Th√™m d√≤ng m·ªõi sau ·∫£nh ƒë·ªÉ d·ªÖ so·∫°n th·∫£o ti·∫øp
                document.execCommand('insertHTML', false, '<br><br>');

            } else {
                alert('Vui l√≤ng click v√†o v·ªã tr√≠ b·∫°n mu·ªën ch√®n ·∫£nh tr∆∞·ªõc khi nh·∫•n n√∫t "Th√™m ·∫£nh".');
            }
        };

        reader.readAsDataURL(file);
    }
    event.target.value = ''; 
});

// --- KH·ªûI T·∫†O V√Ä S·ª∞ KI·ªÜN CHUNG ---
prevBtn.addEventListener('click', () => {
    if (currentPage > 0) currentPage--;
    updatePages();
});

nextBtn.addEventListener('click', () => {
    if (currentPage < pages.length - 1) currentPage++;
    updatePages();
});

addPageSidebarBtn.addEventListener('click', (e) => {
    e.preventDefault();
    addNewPage();
});

addPagePanelBtn.addEventListener('click', addNewPage);

toggleToolbarMenu.addEventListener('click', () => {
    floatingMenu.classList.toggle('show');
});

musicToggle.addEventListener('click', () => {
    if (bgMusic.paused) { bgMusic.play(); musicToggle.textContent = 'üîä'; }
    else { bgMusic.pause(); musicToggle.textContent = 'üîá'; }
});


function initBook() {
    book.innerHTML = '';
    pages = [];
    currentPage = 0;

    // B√¨a
    createPage(Layouts.COVER, false);
    
    // Trang m·∫´u 1
    createPage(Layouts.PAGE_1_LAYOUT, true);

    // Th√™m trang tr·∫Øng c√≥ th·ªÉ ch·ªânh s·ª≠a
    createPage(Layouts.PAGE_BLANK, true);

    // Trang cu·ªëi c√πng (kh√¥ng l·∫≠t)
    createPage(Layouts.PAGE_BLANK, false);

    updatePages();
    
    const startBtn = document.getElementById('start-btn');
    if (startBtn) {
        startBtn.addEventListener('click', () => {
            currentPage = 1; 
            updatePages();
        });
    }
}

initBook();
(function(){
  const AUTO_MS=6000;
  const TRANSITION=500;
  const cardsSource=document.querySelector('.cards-source');
  if(!cardsSource) return;
  const cardNodes=Array.from(cardsSource.querySelectorAll('.testimonial-card'));
  if(!cardNodes.length) return;
  const sliderRoot=document.querySelector('.slider-root');
  const dotsRoot=document.querySelector('.dots-root');
  const track=document.createElement('div');
  track.className='slider-track';
  const PALETTE=['#C8F7E0','#E6D8FF','#D7EAFE'];
  const MINT='#C8F7E0';
  cardNodes.forEach((card,i)=>{
    track.appendChild(card);
    const base=PALETTE[i%PALETTE.length];
    card.dataset.baseColor=base;
    card.style.background=base;
  });
  sliderRoot.appendChild(track);
  const dots=[];
  cardNodes.forEach((_,i)=>{
    const b=document.createElement('button');
    b.type='button';
    b.dataset.index=i;
    b.addEventListener('click',()=>{ goTo(i); restartAuto(); });
    dotsRoot.appendChild(b);
    dots.push(b);
  });
  dotsRoot.style.display='flex';
  const gap=parseInt(getComputedStyle(track).gap)||20;
  const cardRect=cardNodes[0].getBoundingClientRect();
  const cardW=Math.round(cardRect.width)||320;
  const sliderWidth=sliderRoot.clientWidth;
  const centerOffset=(sliderWidth/2)-(cardW/2);
  let index=0;
  const total=cardNodes.length;
  let autoTimer=null;
  function clampIdx(i){ return ((i%total)+total)%total; }
  function applyClasses(){
    cardNodes.forEach(c=>{ c.classList.remove('center','side','dim'); });
    const c=clampIdx(index);
    const left=clampIdx(index-1);
    const right=clampIdx(index+1);
    cardNodes[c].classList.add('center');
    cardNodes[c].style.background=MINT;
    if(cardNodes[left]){
      cardNodes[left].classList.add('side');
      cardNodes[left].style.background=cardNodes[left].dataset.baseColor;
    }
    if(cardNodes[right]){
      cardNodes[right].classList.add('side');
      cardNodes[right].style.background=cardNodes[right].dataset.baseColor;
    }
    cardNodes.forEach((card,idx)=>{
      if(idx!==c && idx!==left && idx!==right){
        card.classList.add('dim');
        card.style.background=card.dataset.baseColor;
      }
    });
    dots.forEach((d,i)=>d.classList.toggle('active',i===c));
  }
  function updatePosition(animate=true){
    const x=-(index*(cardW+gap))+centerOffset;
    if(!animate){
      track.style.transition='none';
      track.style.transform=`translateX(${x}px)`;
      void track.offsetWidth;
      track.style.transition=`transform ${TRANSITION}ms ease`;
    } else {
      track.style.transform=`translateX(${x}px)`;
    }
    applyClasses();
  }
  function goTo(i){ index=clampIdx(i); updatePosition(true); }
  function next(){ goTo(index+1); }
  function prev(){ goTo(index-1); }
  function startAuto(){ stopAuto(); autoTimer=setInterval(()=>{ next(); },AUTO_MS); }
  function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
  function restartAuto(){ stopAuto(); startAuto(); }
  sliderRoot.addEventListener('mouseenter',stopAuto);
  sliderRoot.addEventListener('mouseleave',startAuto);
  sliderRoot.addEventListener('focusin',stopAuto);
  sliderRoot.addEventListener('focusout',startAuto);
  window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft'){ prev(); restartAuto(); } if(e.key==='ArrowRight'){ next(); restartAuto(); } });
  track.addEventListener('click',(ev)=>{
    const card=ev.target.closest('.testimonial-card');
    if(!card) return;
    const i=cardNodes.indexOf(card);
    if(i===-1) return;
    if(i!==index){ goTo(i); restartAuto(); }
  });
  index=1<total?1:0;
  track.style.transition=`transform ${TRANSITION}ms ease`;
  updatePosition(false);
  startAuto();
  window.__testimonialSlider={ goTo, next, prev, startAuto, stopAuto };
})();
</script>
</body>
</html>